generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum PlanType {
  FREE
  PRO
  TEAM
  ENTERPRISE

  @@map("plan_type")
}

enum SSLStatus {
  PENDING
  PROVISIONING
  ACTIVE
  ERROR

  @@map("ssl_status")
}

enum TeamRole {
  VIEWER
  MEMBER
  DEVELOPER
  ADMIN
  OWNER

  @@map("team_role")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED

  @@map("invitation_status")
}

enum UsageType {
  BUILD_MINUTES
  BANDWIDTH
  REQUESTS
  FUNCTION_INVOCATIONS
  BLOB_STORAGE
  DEPLOYMENTS

  @@map("usage_type")
}

enum DatabaseStatus {
  PROVISIONING
  ACTIVE
  ERROR
  SUSPENDED
  DELETING
  DELETED

  @@map("database_status")
}

enum DatabaseType {
  POSTGRESQL
  MYSQL
  REDIS
  MONGODB

  @@map("database_type")
}

enum NotificationChannel {
  EMAIL
  SLACK
  WEBHOOK

  @@map("notification_channel")
}

enum DeploymentStatus {
  QUEUED
  BUILDING
  DEPLOYING
  READY
  ERROR
  CANCELLED
}

// ============ USERS & AUTH ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  passwordHash  String?
  image         String?   // Profile image (from OAuth or uploaded)
  emailVerified DateTime? // NextAuth email verification
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Billing fields
  plan               PlanType  @default(FREE)
  stripeCustomerId   String?   @unique
  subscriptionId     String?   @unique
  subscriptionStatus String?   // active, canceled, past_due, unpaid
  currentPeriodEnd   DateTime?

  // Onboarding
  onboardingCompleted Boolean   @default(false)
  onboardingStep      Int       @default(0)   // Current step: 0=not started, 1-5=in progress

  accounts                Account[]
  projects                Project[]
  activities              Activity[]
  teamMembers             TeamMember[]
  usageRecords            UsageRecord[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  sentInvitations         TeamInvitation[] @relation("InvitedBy")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId, provider])
}

// ============ PROJECTS & DEPLOYMENTS ============

model Project {
  id              String   @id @default(cuid())
  name            String
  slug            String
  userId          String
  repositoryUrl   String?  @map("repoUrl")
  repositoryBranch String  @default("main") @map("repoBranch")
  framework       String   @default("nextjs")
  buildCommand    String   @default("npm run build") @map("buildCmd")
  outputDirectory String   @default(".next") @map("outputDir")
  installCommand  String   @default("npm install") @map("installCmd")
  rootDirectory   String   @default("./") @map("rootDir")
  nodeVersion     String   @default("20")
  monorepoTool    String?  // turborepo, nx, lerna, pnpm, yarn, npm
  monorepoPackage String?  // Package name within monorepo
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  deployments        Deployment[]
  envVariables       EnvVariable[]
  domains            Domain[]
  activities         Activity[]
  teamProjects       TeamProject[]
  usageRecords       UsageRecord[]
  featureFlags       FeatureFlag[]
  analyticsEvents    AnalyticsEvent[]
  functions          ServerlessFunction[]
  blobStores         BlobStore[]
  kvStores           KVStore[]
  edgeConfigs        EdgeConfig[]
  integrations       Integration[]
  cronJobs           CronJob[]
  managedDatabases   ManagedDatabase[]
  edgeFunctions      EdgeFunction[]

  @@unique([userId, slug])
  @@index([userId])
}

model Deployment {
  id            String           @id @default(cuid())
  projectId     String
  status        DeploymentStatus @default(QUEUED)
  commitSha     String?
  commitMessage String?          @db.Text
  branch        String           @default("main")
  url           String?
  buildTime     Int?
  artifactPath  String?          // Path to built files: /data/builds/{siteSlug}
  siteSlug      String?          // Subdomain for serving: {slug}.projects.tranthachnguyen.com
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  finishedAt    DateTime?

  // Rollback support
  isActive      Boolean          @default(false) // Currently serving traffic
  promotedAt    DateTime?        // When this deployment was promoted/rolled back to
  promotedBy    String?          // User who promoted this deployment

  // Preview deployment support
  isPreview     Boolean          @default(false)
  prNumber      Int?             // PR number for preview deployments

  project Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  logs    DeploymentLog[]

  @@index([projectId])
  @@index([status])
  @@index([projectId, isActive])
  @@index([projectId, createdAt])
  @@index([projectId, status])
  @@index([projectId, branch])
  @@index([siteSlug])
}

model DeploymentLog {
  id           String   @id @default(cuid())
  deploymentId String
  level        String   @default("info")
  message      String   @db.Text
  timestamp    DateTime @default(now())

  deployment Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@index([deploymentId])
}

model EnvVariable {
  id        String   @id @default(cuid())
  projectId String
  key       String
  value     String   @db.Text
  isSecret  Boolean  @default(false)
  target    String   @default("production")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, key, target])
  @@index([projectId])
}

// ============ CUSTOM DOMAINS ============

model Domain {
  id                String    @id @default(cuid())
  domain            String    @unique
  projectId         String
  verified          Boolean   @default(false)
  sslStatus         SSLStatus @default(PENDING)
  verificationToken String
  sslCertPath       String?
  sslKeyPath        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([domain])
}

// ============ ACME ACCOUNT ============

model AcmeAccount {
  id          String   @id @default(cuid())
  environment String   @unique // "production" or "staging"
  accountUrl  String   // ACME account URL from Let's Encrypt
  privateKey  String   // PEM-encoded ECDSA private key (encrypted)
  email       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============ CRON JOBS ============

model CronJob {
  id          String    @id @default(cuid())
  projectId   String
  name        String
  schedule    String    // Cron expression (e.g., "0 * * * *")
  path        String    // API route to call (e.g., "/api/cron/cleanup")
  enabled     Boolean   @default(true)
  timezone    String    @default("UTC")
  timeout     Int       @default(60) // seconds
  retryCount  Int       @default(0)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  lastStatus  String?   // "success", "failed"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project    Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  executions CronExecution[]

  @@index([projectId])
  @@index([enabled, nextRunAt])
}

model CronExecution {
  id           String    @id @default(cuid())
  jobId        String
  status       String    // "pending", "running", "success", "failed"
  startedAt    DateTime
  finishedAt   DateTime?
  duration     Int?      // milliseconds
  response     String?   @db.Text
  error        String?   @db.Text
  retryAttempt Int       @default(0)

  job CronJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
}

// ============ ACTIVITY FEED ============

model Activity {
  id          String   @id @default(cuid())
  userId      String
  projectId   String?
  teamId      String?
  type        String   // deployment, domain, env_var, project, team, etc.
  action      String   // created, updated, deleted, deployed, verified, etc.
  description String
  metadata    Json?    // Additional context
  ipAddress   String?  // Client IP address for audit
  userAgent   String?  // Client user agent for audit
  createdAt   DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  team    Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([projectId])
  @@index([teamId])
  @@index([createdAt])
  @@index([type])
  @@index([action])
  @@index([userId, type, createdAt])
  @@index([projectId, type, createdAt])
}

// ============ TEAMS & ORGANIZATIONS ============

model Team {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  image       String?
  plan        PlanType @default(FREE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members      TeamMember[]
  teamProjects TeamProject[]
  invitations  TeamInvitation[]
  activities   Activity[]
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      TeamRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamProject {
  id        String   @id @default(cuid())
  teamId    String
  projectId String

  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([teamId, projectId])
  @@index([teamId])
  @@index([projectId])
}

model TeamInvitation {
  id         String           @id @default(cuid())
  teamId     String
  email      String
  role       TeamRole         @default(MEMBER)
  token      String           @unique
  invitedBy  String
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  createdAt  DateTime         @default(now())
  acceptedAt DateTime?

  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  inviter User @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@unique([teamId, email])
  @@index([token])
  @@index([email])
  @@index([status])
}

// ============ USAGE TRACKING ============

model UsageRecord {
  id         String    @id @default(cuid())
  userId     String
  projectId  String?
  type       UsageType
  value      Float     // Usage amount in the appropriate unit
  metadata   Json?     // Additional context (deploymentId, functionId, etc.)
  recordedAt DateTime  @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId, recordedAt])
  @@index([projectId, recordedAt])
  @@index([type, recordedAt])
  @@index([userId, type, recordedAt])
}

// ============ FEATURE FLAGS ============

model FeatureFlag {
  id          String   @id @default(cuid())
  projectId   String
  key         String
  name        String
  description String?
  enabled     Boolean  @default(false)
  percentage  Int      @default(100) // Rollout percentage
  conditions  Json?    // Targeting rules
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, key])
  @@index([projectId])
}

// ============ ANALYTICS ============

model AnalyticsEvent {
  id         String   @id @default(cuid())
  projectId  String
  domainId   String?
  type       String   // pageview, event, vitals
  path       String?
  referrer   String?
  userAgent  String?
  country    String?
  device     String?  // desktop, mobile, tablet
  browser    String?
  os         String?
  eventName  String?
  eventData  Json?
  sessionId  String?
  visitorId  String?
  createdAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
  @@index([projectId, path])
  @@index([sessionId])
  @@index([projectId, type, createdAt])
  @@index([visitorId, createdAt])
}

// ============ SERVERLESS FUNCTIONS ============

model ServerlessFunction {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  runtime     String   @default("nodejs20") // nodejs18, nodejs20, python3.9, etc.
  entrypoint  String   @default("api/index.js")
  memory      Int      @default(128) // MB
  timeout     Int      @default(10)  // seconds
  regions     String[] // ["iad1", "sfo1", "cdg1"]
  envVars     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invocations FunctionInvocation[]

  @@unique([projectId, name])
  @@index([projectId])
}

model FunctionInvocation {
  id         String   @id @default(cuid())
  functionId String
  status     String   // success, error, timeout
  duration   Int      // ms
  memory     Int      // MB used
  region     String
  statusCode Int?
  error      String?
  createdAt  DateTime @default(now())

  function ServerlessFunction @relation(fields: [functionId], references: [id], onDelete: Cascade)

  @@index([functionId, createdAt])
}

// ============ BLOB STORAGE ============

model BlobStore {
  id        String   @id @default(cuid())
  projectId String
  name      String
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  blobs   Blob[]

  @@unique([projectId, name])
  @@index([projectId])
}

model Blob {
  id          String   @id @default(cuid())
  storeId     String
  pathname    String
  contentType String
  size        Int      // bytes
  url         String
  downloadUrl String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store BlobStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, pathname])
  @@index([storeId])
}

// ============ KV STORE ============

model KVStore {
  id        String   @id @default(cuid())
  projectId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  entries KVEntry[]

  @@unique([projectId, name])
  @@index([projectId])
}

model KVEntry {
  id        String   @id @default(cuid())
  storeId   String
  key       String
  value     String   @db.Text
  expiresAt DateTime?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store KVStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, key])
  @@index([storeId])
  @@index([expiresAt])
}

// ============ EDGE CONFIG ============

model EdgeConfig {
  id        String   @id @default(cuid())
  projectId String
  name      String
  slug      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items   EdgeConfigItem[]

  @@unique([projectId, slug])
  @@index([projectId])
}

model EdgeConfigItem {
  id        String   @id @default(cuid())
  configId  String
  key       String
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config EdgeConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, key])
  @@index([configId])
}

// ============ INTEGRATIONS ============

model Integration {
  id           String   @id @default(cuid())
  projectId    String
  type         String   // github, slack, discord, vercel-postgres, etc.
  name         String
  config       Json?    // Integration-specific configuration
  credentials  Json?    // Encrypted credentials
  enabled      Boolean  @default(true)
  webhookUrl   String?
  lastSyncAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, type])
  @@index([projectId])
}

// ============ NOTIFICATIONS ============

model NotificationPreference {
  id           String              @id @default(cuid())
  userId       String
  channel      NotificationChannel
  type         String              // deployment_success, deployment_failure, domain_verified, etc.
  enabled      Boolean             @default(true)
  destination  String?             // email address, slack channel, webhook URL
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel, type])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@index([userId, read, createdAt])
}

// ============ WEB VITALS ============

model WebVital {
  id        String   @id @default(cuid())
  projectId String
  url       String
  metric    String   // LCP, FID, CLS, TTFB, FCP, INP
  value     Float
  rating    String   // good, needs-improvement, poor
  device    String?  // desktop, mobile
  browser   String?
  country   String?
  createdAt DateTime @default(now())

  @@index([projectId, metric, createdAt])
  @@index([projectId, url])
  @@index([projectId, metric, rating])
}

// ============ MANAGED DATABASES ============

model ManagedDatabase {
  id        String @id @default(cuid())
  projectId String

  name     String
  type     DatabaseType
  provider String // cloudify, neon, planetscale, upstash

  // Connection details (encrypted)
  host     String
  port     Int
  database String
  username String
  password String  @db.Text // Encrypted
  sslMode  String  @default("require")

  // Provisioning state
  status       DatabaseStatus @default(PROVISIONING)
  errorMessage String?

  // Resource limits
  plan            String @default("hobby") // hobby, pro, enterprise
  storageLimit    Int    @default(512) // MB
  connectionLimit Int    @default(5)

  // Usage metrics
  storageUsed       Int    @default(0)
  connectionsActive Int    @default(0)
  queriesTotal      BigInt @default(0)

  // Docker container ID (for cloudify-hosted databases)
  containerId String?

  // Metadata
  region  String  @default("us-east-1")
  version String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  migrations DatabaseMigration[]
  backups    DatabaseBackup[]
  metrics    DatabaseMetric[]

  @@unique([projectId, name])
  @@index([projectId])
  @@index([status])
}

model DatabaseMigration {
  id         String @id @default(cuid())
  databaseId String

  name     String
  version  String
  type     String // up, down, seed

  content  String @db.Text // SQL or migration script
  checksum String

  status    String    @default("pending") // pending, running, applied, failed, rolled_back
  appliedAt DateTime?
  duration  Int? // ms

  error String? @db.Text

  createdAt DateTime @default(now())

  database ManagedDatabase @relation(fields: [databaseId], references: [id], onDelete: Cascade)

  @@index([databaseId, status])
}

model DatabaseBackup {
  id         String @id @default(cuid())
  databaseId String

  type   String // manual, scheduled, before_migration
  status String // pending, in_progress, completed, failed

  size Int?    // bytes
  path String? // MinIO path

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?

  error String?

  database ManagedDatabase @relation(fields: [databaseId], references: [id], onDelete: Cascade)

  @@index([databaseId])
  @@index([status])
}

model DatabaseMetric {
  id         String @id @default(cuid())
  databaseId String

  timestamp DateTime @default(now())

  // Performance metrics
  queryCount   Int
  avgQueryTime Float // ms
  slowQueries  Int // > 1s

  // Resource metrics
  cpuUsage     Float? // percentage
  memoryUsage  Float? // percentage
  storageUsage Float? // MB
  connections  Int

  database ManagedDatabase @relation(fields: [databaseId], references: [id], onDelete: Cascade)

  @@index([databaseId, timestamp])
}

// ============ EDGE FUNCTIONS ============

model EdgeFunction {
  id        String  @id @default(cuid())
  projectId String
  name      String
  slug      String
  code      String  @db.Text // JavaScript/TypeScript code

  // Runtime configuration
  runtime String   @default("edge-runtime") // edge-runtime, deno
  regions String[] @default(["global"])     // global, iad1, sfo1, cdg1, etc.
  memory  Int      @default(128) // MB (max 256 for edge)
  timeout Int      @default(30)  // seconds (max 30 for edge)

  // Feature flags
  enabled          Boolean @default(true)
  cacheEnabled     Boolean @default(false)
  cacheTtl         Int?    // seconds
  geolocationEnabled Boolean @default(false)

  // Routing
  routes String[] // URL patterns: ["/api/*", "/middleware"]

  // Environment
  envVars Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invocations EdgeInvocation[]

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([enabled])
}

model EdgeInvocation {
  id         String @id @default(cuid())
  functionId String

  status   String // success, error, timeout
  duration Int    // ms
  memory   Int    // MB used
  region   String

  requestPath   String?
  requestMethod String?
  statusCode    Int?

  // Geolocation context
  country String?
  city    String?

  error     String? @db.Text
  createdAt DateTime @default(now())

  function EdgeFunction @relation(fields: [functionId], references: [id], onDelete: Cascade)

  @@index([functionId, createdAt])
  @@index([status])
}
